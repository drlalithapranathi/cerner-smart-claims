<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Smart Claims ‚Äì Callback</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.min.js"></script>

  <!-- ===== Clean, modern styles (no frameworks) ===== -->
  <style>
    :root{
      --bg:#0b1020;
      --panel:#121830;
      --muted:#8891a7;
      --text:#e6ecff;
      --accent:#6aa7ff;
      --ok:#00d68f;
      --warn:#ffd166;
      --err:#ff6b6b;
      --chip:#1b2447;
      --border:#1d2a4d;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; padding:24px;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:linear-gradient(180deg,#0b1020 0%,#0b0f1b 100%);
      color:var(--text);
    }
    header{
      display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:18px;
    }
    .app-title{font-size:clamp(22px,2.3vw,30px); font-weight:800; letter-spacing:.2px}
    .subtitle{color:var(--muted); font-size:.95rem}
    .grid{
      display:grid; gap:16px;
      grid-template-columns: repeat(auto-fill,minmax(320px,1fr));
    }
    .card{
      background:var(--panel); border:1px solid var(--border); border-radius:16px;
      padding:16px; box-shadow:0 10px 24px rgba(0,0,0,.25);
    }
    .card h3{
      margin:0 0 10px 0; font-size:1.05rem; font-weight:700; letter-spacing:.2px;
      display:flex; align-items:center; gap:8px;
    }
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:2px 8px; border-radius:999px; font-size:.78rem; background:var(--chip); color:var(--muted);
      border:1px solid var(--border);
    }
    .badge.ok{ color:#0fe1a4; }
    .badge.warn{ color:#ffd166; }
    .badge.err{ color:#ff8080; }
    .kv{display:grid; grid-template-columns:140px 1fr; gap:8px 12px; font-size:.95rem}
    .kv b{ color:#a9b5d9; font-weight:600 }
    .table{
      width:100%; border-collapse:collapse; font-size:.92rem; overflow:hidden; border-radius:12px; border:1px solid var(--border);
    }
    .table th, .table td{ text-align:left; padding:10px 12px; border-bottom:1px solid var(--border) }
    .table th{ background:#101734; color:#b7c2e8; font-weight:700 }
    .table tr:hover td{ background:#121c3f }
    .chips{ display:flex; flex-wrap:wrap; gap:6px }
    .chip{
      background:var(--chip); color:#bcd0ff; border:1px solid var(--border);
      padding:4px 8px; border-radius:999px; font-size:.8rem;
    }
    .mono{ font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; color:#bcd0ff }
    .footer-note{ margin-top:16px; color:var(--muted); font-size:.85rem }
    .hidden{ display:none }
  </style>
</head>
<body>
  <header>
    <div>
      <div class="app-title">Smart Claims</div>
      <div id="status" class="subtitle">Completing SMART sign-in‚Ä¶</div>
    </div>
    <div id="badges" class="chips"></div>
  </header>

  <div id="grid" class="grid"></div>
  <div id="errors"></div>

  <script>
    // ---------- tiny view helpers ----------
    const grid = document.getElementById("grid");
    const badges = document.getElementById("badges");
    const statusLine = document.getElementById("status");

    const addBadge = (text, type) => {
      const span = document.createElement("span");
      span.className = `badge ${type||""}`;
      span.textContent = text;
      badges.appendChild(span);
    };

    const card = (title, icon, bodyNode) => {
      const c = document.createElement("div");
      c.className = "card";
      c.innerHTML = `<h3>${icon||""} ${title}</h3>`;
      c.appendChild(bodyNode);
      grid.appendChild(c);
    };

    const kv = (pairs) => {
      const wrap = document.createElement("div");
      wrap.className = "kv";
      for (const [k,v] of pairs) {
        const kEl = document.createElement("b"); kEl.textContent = k;
        const vEl = document.createElement("div"); vEl.innerHTML = v ?? "<span class='mono'>‚Äî</span>";
        wrap.appendChild(kEl); wrap.appendChild(vEl);
      }
      return wrap;
    };

    const table = (columns, rows) => {
      const tbl = document.createElement("table"); tbl.className = "table";
      const thead = document.createElement("thead");
      thead.innerHTML = `<tr>${columns.map(c=>`<th>${c.label}</th>`).join("")}</tr>`;
      const tbody = document.createElement("tbody");
      rows.forEach(r=>{
        const tr = document.createElement("tr");
        tr.innerHTML = columns.map(c=>`<td>${(c.render?c.render(r):r[c.key]) ?? ""}</td>`).join("");
        tbody.appendChild(tr);
      });
      tbl.appendChild(thead); tbl.appendChild(tbody);
      return tbl;
    };

    const fmtDate = s => (s ? new Date(s).toLocaleString() : "");

    // surface silent JS errors nicely
    window.addEventListener("error", e => {
      const el = document.createElement("div");
      el.className = "card";
      el.innerHTML = `<h3>‚ö†Ô∏è Runtime Error</h3><div class="mono">${e.message}</div>`;
      document.body.appendChild(el);
    });
    window.addEventListener("unhandledrejection", e => {
      const el = document.createElement("div");
      el.className = "card";
      el.innerHTML = `<h3>‚ö†Ô∏è Promise Rejection</h3><div class="mono">${(e.reason && (e.reason.message||e.reason))||e}</div>`;
      document.body.appendChild(el);
    });

    // ---------- main ----------
    (async () => {
      const client = await FHIR.oauth2.ready(); // completes OAuth code+PKCE exchange
      statusLine.textContent = "Connected";

      // connection info (compact)
      const token = client.state?.tokenResponse || {};
      addBadge("SMART OK", "ok");
      addBadge(`scope: ${String(token.scope||"").split(" ").length} items`, "");
      addBadge(`exp: ${Math.round((token.expires_in||0)/60)}m`, "");

      // Capabilities
      try {
        const meta = await client.request("metadata");
        const info = kv([
          ["FHIR Version", `<span class="mono">${meta.fhirVersion||"?"}</span>`],
          ["Server", `<span class="mono">${client.state?.serverUrl||""}</span>`],
          ["Status", `<span class="mono">${meta.status||"unknown"}</span>`],
        ]);
        card("Server Info", "üõ∞Ô∏è", info);
      } catch { /* ignore */ }

      // Patient
      let patientId = client.patient?.id || null;
      if (!patientId) {
        try {
          const b = await client.request("Patient?_count=1");
          patientId = b.entry?.[0]?.resource?.id || null;
          addBadge("No launch context ‚Üí using first Patient", "warn");
        } catch (e) {
          card("Patient", "üë§", kv([["Error", e.message]]));
          return;
        }
      }

      if (patientId) {
        try {
          const p = await client.request(`Patient/${patientId}`);
          const name = `${(p.name?.[0]?.given||[]).join(" ")} ${p.name?.[0]?.family||""}`.trim();
          card("Patient", "üë§", kv([
            ["ID", `<span class="mono">Patient/${p.id}</span>`],
            ["Name", name||"‚Äî"],
            ["DOB", p.birthDate||"‚Äî"],
            ["Gender", p.gender||"‚Äî"],
          ]));
        } catch (e) {
          card("Patient", "üë§", kv([["Read failed", e.message]]));
        }
      }

      // Last Encounter
      let lastEncounter = null;
      try {
        const encs = await client.request(`Encounter?patient=${patientId}&_sort=-date&_count=1`);
        if (encs.entry?.length) {
          lastEncounter = encs.entry[0].resource;
          card("Last Encounter", "üè•", kv([
            ["ID", `<span class="mono">Encounter/${lastEncounter.id}</span>`],
            ["Status", lastEncounter.status||"‚Äî"],
            ["Class", (lastEncounter.class?.display||lastEncounter.class?.code)||"‚Äî"],
            ["Type", (lastEncounter.type||[]).map(t=>t.coding?.[0]?.display||t.text).filter(Boolean).join(", ")||"‚Äî"],
            ["Start", fmtDate(lastEncounter.period?.start) || "‚Äî"],
            ["End", fmtDate(lastEncounter.period?.end) || "‚Äî"],
            ["Location", (lastEncounter.location||[]).map(l=>l.location?.display).filter(Boolean).join(", ")||"‚Äî"],
          ]));
        } else {
          addBadge("No Encounters", "warn");
        }
      } catch (e) {
        card("Last Encounter", "üè•", kv([["Error", e.message]]));
      }

      // -------- Billing (ChargeItem) by context, fallback account --------
      try {
        let chargeItems = [];

        // 1) by Encounter context (Cerner requires context/account/_id; not patient=)
        if (lastEncounter?.id) {
          const byEnc = await client.request(
            `ChargeItem?context=Encounter/${lastEncounter.id}` +
            `&_elements=id,code,subject,context,account,occurrenceDateTime&_count=50`
          );
          chargeItems.push(...(byEnc.entry||[]).map(e=>e.resource));
        }

        // 2) fallback: by Account(s) for patient
        if (!chargeItems.length) {
          try {
            const accts = await client.request(`Account?patient=${patientId}&_elements=id,name,type,status&_count=10`);
            const ids = (accts.entry||[]).map(e=>e.resource?.id).filter(Boolean);
            for (const id of ids) {
              const byAcct = await client.request(
                `ChargeItem?account=Account/${id}` +
                `&_elements=id,code,subject,context,account,occurrenceDateTime&_count=50`
              );
              chargeItems.push(...(byAcct.entry||[]).map(e=>e.resource));
            }
          } catch { /* no accounts present is OK */ }
        }

        const rows = chargeItems.map(ci => ({
          id: ci.id,
          when: ci.occurrenceDateTime || ci.effectiveTime || "",
          codes: (ci.code?.coding||[]).map(c=>c.display||c.code).filter(Boolean).join(", "),
          context: ci.context?.reference || "",
          account: (ci.account||[]).map(a=>a.reference).join(", ")
        }));

        const body = rows.length
          ? table(
              [
                {key:"id", label:"ChargeItem", render:r=>`<span class="mono">${r.id}</span>`},
                {key:"codes", label:"Code(s)"},
                {key:"when", label:"Date/Time", render:r=>fmtDate(r.when)},
                {key:"context", label:"Context"},
                {key:"account", label:"Account"},
              ],
              rows
            )
          : kv([["Info","No ChargeItems found via encounter or account."]]);

        card("Billing (ChargeItem)", "üí≥", body);
      } catch (e) {
        card("Billing (ChargeItem)", "üí≥", kv([["Error", e.message]]));
      }

      // ServiceRequest (radiology-ish)
      try {
        const sr = await client.request(`ServiceRequest?patient=${patientId}&_count=20`);
        const rows = (sr.entry||[]).map(e=>e.resource).map(r=>({
          id:r.id,
          status:r.status, intent:r.intent, priority:r.priority||"",
          code:r.code?.coding?.[0]?.display||r.code?.text||"",
          authoredOn: r.authoredOn||"",
        }));
        if (rows.length) {
          card("Orders (ServiceRequest)", "üìù", table(
            [
              {key:"id", label:"ID", render:r=>`<span class="mono">${r.id}</span>`},
              {key:"code", label:"Order"},
              {key:"status", label:"Status"},
              {key:"intent", label:"Intent"},
              {key:"priority", label:"Priority"},
              {key:"authoredOn", label:"Authored", render:r=>fmtDate(r.authoredOn)}
            ],
            rows
          ));
        }
      } catch {}

      // DiagnosticReport
      try {
        const dr = await client.request(`DiagnosticReport?patient=${patientId}&_count=20`);
        const rows = (dr.entry||[]).map(e=>e.resource).map(r=>({
          id:r.id,
          code:r.code?.coding?.[0]?.display||r.code?.text||"",
          status:r.status||"",
          issued:r.issued||r.effectiveDateTime||"",
        }));
        if (rows.length) {
          card("Diagnostic Reports", "üß™", table(
            [
              {key:"id", label:"ID", render:r=>`<span class="mono">${r.id}</span>`},
              {key:"code", label:"Report"},
              {key:"status", label:"Status"},
              {key:"issued", label:"When", render:r=>fmtDate(r.issued)}
            ],
            rows
          ));
        }
      } catch {}

      // Observations from last encounter (if any)
      if (lastEncounter?.id) {
        try {
          const obs = await client.request(`Observation?patient=${patientId}&encounter=${lastEncounter.id}&_count=50`);
          const rows = (obs.entry||[]).map(e=>e.resource).map(o=>{
            const simple =
              (o.valueQuantity ? `${o.valueQuantity.value} ${o.valueQuantity.unit}` : null) ||
              o.valueString ||
              "";
            return {
              id:o.id,
              code:o.code?.coding?.[0]?.display||o.code?.text||"",
              value: simple,
              time:o.effectiveDateTime||""
            };
          });
          if (rows.length) {
            card("Observations (Last Encounter)", "üìà", table(
              [
                {key:"id", label:"ID", render:r=>`<span class="mono">${r.id}</span>`},
                {key:"code", label:"Observation"},
                {key:"value", label:"Value"},
                {key:"time", label:"When", render:r=>fmtDate(r.time)}
              ],
              rows
            ));
          }
        } catch {}
      }

      // Conditions (quick context)
      try {
        const cond = await client.request(`Condition?patient=${patientId}&_count=20`);
        const rows = (cond.entry||[]).map(e=>e.resource).map(c=>({
          id:c.id,
          name:c.code?.coding?.[0]?.display||c.code?.text||"",
          status:c.clinicalStatus?.coding?.[0]?.display||""
        }));
        if (rows.length) {
          card("Conditions", "üè∑Ô∏è", table(
            [
              {key:"id", label:"ID", render:r=>`<span class="mono">${r.id}</span>`},
              {key:"name", label:"Condition"},
              {key:"status", label:"Status"}
            ],
            rows
          ));
        }
      } catch {}

      // Claims-ish (may be empty in sandbox)
      try {
        const cov = await client.request(`Coverage?patient=${patientId}&_count=5`);
        const rows = (cov.entry||[]).map(e=>e.resource).map(c=>({
          id:c.id,
          status:c.status||"",
          payor:(c.payor||[]).map(p=>p.display||p.reference).join(", ")
        }));
        if (rows.length) {
          card("Coverage", "üõ°Ô∏è", table(
            [
              {key:"id", label:"ID", render:r=>`<span class="mono">${r.id}</span>`},
              {key:"status", label:"Status"},
              {key:"payor", label:"Payor"}
            ],
            rows
          ));
        }
      } catch {}
    })();
  </script>

  <div class="footer-note">Tip: this view summarizes data in friendly tables. Raw JSON is intentionally not shown.</div>
</body>
</html>
