<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Smart Claims ‚Äì Callback</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{
      /* Light vibrant theme */
      --bg1:#f7fbff;
      --bg2:#eef4ff;
      --panel:rgba(255,255,255,0.88);
      --panel-blur:10px;
      --text:#0b1220;
      --muted:#657094;
      --border:#e6ecff;
      --ok:#12b886;
      --warn:#f59f00;
      --err:#e03131;
      --hdr:#f2f5ff;
      --accent:#3b82f6;
      --accent-2:#8b5cf6;
      --chip:#eef2ff;
      --shadow:0 18px 40px rgba(30,55,135,.12), 0 4px 14px rgba(30,55,135,.06);
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; padding:26px;
      background:
        radial-gradient(1200px 800px at -10% -20%, #e9f6ff 10%, transparent 60%),
        radial-gradient(1200px 800px at 110% -10%, #f0eaff 10%, transparent 60%),
        linear-gradient(180deg,var(--bg1),var(--bg2));
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Inter, Arial, sans-serif;
    }
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:20px}
    .app-title{font-weight:900;letter-spacing:.2px;font-size:clamp(24px,2.6vw,34px);background:linear-gradient(90deg,#0f172a,#334155);-webkit-background-clip:text;background-clip:text;color:transparent}
    .subtitle{color:var(--muted);font-size:.95rem}
    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .badge{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 12px;border-radius:999px;
      background:var(--chip);border:1px solid var(--border);
      font-size:.8rem;color:#334155; backdrop-filter:saturate(130%) blur(6px)
    }
    .badge.ok{color:var(--ok)} .badge.warn{color:var(--warn)} .badge.err{color:var(--err)}
    .grid{display:grid;gap:18px;grid-template-columns:repeat(12,1fr)}
    @media (max-width:980px){.grid{grid-template-columns:repeat(6,1fr)}}
    @media (max-width:640px){.grid{grid-template-columns:repeat(1,1fr)}}
    .span-4{grid-column:span 4} .span-5{grid-column:span 5}
    .span-6{grid-column:span 6} .span-7{grid-column:span 7}
    .span-8{grid-column:span 8} .span-12{grid-column:span 12}
    .card{
      position:relative;
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:16px 16px 10px;
      box-shadow:var(--shadow);
      backdrop-filter: blur(var(--panel-blur));
      transform: translateZ(0);
      overflow:hidden;
    }
    /* soft corner sheen */
    .card::after{
      content:"";
      position:absolute; inset:-1px -1px auto auto;
      width:180px; height:180px; border-radius:50%;
      background: radial-gradient(closest-side,rgba(139,92,246,.10),transparent 80%);
      filter: blur(8px); pointer-events:none;
      transform: translate(40%, -40%);
    }
    .card h3{margin:0 0 12px; font-size:1rem; font-weight:800; letter-spacing:.2px; display:flex; align-items:center; gap:10px}
    .kv{
      display:grid; grid-template-columns: 140px 1fr;
      gap:8px 12px; font-size:.95rem; word-break:break-word;
    }
    .kv b{ color:#334155; font-weight:700; align-self:start }
    .kv .mono{ white-space:pre-wrap; word-break:break-all }
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; color:#0f172a}
    .table-wrap{max-height:420px;overflow:auto;border-radius:12px;border:1px solid var(--border);background:#fff}
    table{width:100%;border-collapse:collapse;font-size:.92rem}
    thead th{position:sticky;top:0;background:linear-gradient(180deg,var(--hdr),#ffffff);color:#334155;text-align:left;border-bottom:1px solid var(--border);padding:10px 12px}
    tbody td{padding:10px 12px;border-bottom:1px solid var(--border)}
    tbody tr:hover td{background:linear-gradient(90deg,#f7faff,#ffffff)}
    .muted{color:var(--muted)}
    .empty{padding:8px 0;color:var(--muted)}
    a.link{color:var(--accent); text-decoration:none}
    a.link:hover{text-decoration:underline}
    /* vitals cards */
    .vital-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    @media (max-width:980px){.vital-grid{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:540px){.vital-grid{grid-template-columns:1fr}}
    .vital{
      background:#fff;border:1px solid var(--border);border-radius:14px;padding:10px 12px;
      box-shadow:0 8px 16px rgba(59,130,246,.08);
    }
    .v-label{display:flex; align-items:baseline; gap:8px; margin-bottom:4px}
    .v-name{font-weight:700}
    .v-now{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; color:#111827}
    .v-meta{font-size:.8rem;color:var(--muted)}
    
    /* Vitals chart container */
    .chart-wrap {
      height: 80px;
      position: relative;
      margin-top: 8px;
    }
    .chart-wrap canvas {
      width: 100% !important;
      height: 80px !important;
      display: block;
    }
  </style>
</head>
<body>
  <header>
    <div>
      <div class="app-title">Smart Claims</div>
      <div id="status" class="subtitle">Completing SMART sign-in‚Ä¶</div>
    </div>
    <div id="badges" class="chips"></div>
  </header>
  <div id="grid" class="grid"></div>
  <script>
    // ---------- small view helpers ----------
    const grid = document.getElementById("grid");
    const badges = document.getElementById("badges");
    const statusEl = document.getElementById("status");
    const addBadge = (text, type="")=>{
      const b=document.createElement("span"); b.className=`badge ${type}`; b.textContent=text; badges.appendChild(b);
    };
    const card = (title, icon, span="span-4")=>{
      const c=document.createElement("div"); c.className=`card ${span}`;
      c.innerHTML=`<h3>${icon||""} ${title}</h3>`; grid.appendChild(c); return c;
    };
    const kv = pairs=>{
      const wrap=document.createElement("div"); wrap.className="kv";
      for(const [k,v] of pairs){
        const kEl=document.createElement("b"); kEl.textContent=k;
        const vEl=document.createElement("div"); vEl.innerHTML=v ?? "<span class='muted'>‚Äî</span>";
        wrap.appendChild(kEl); wrap.appendChild(vEl);
      }
      return wrap;
    };
    const tbl = (columns, rows)=>{
      if(!rows.length){const d=document.createElement("div"); d.className="empty"; d.textContent="No data"; return d;}
      const wrap=document.createElement("div"); wrap.className="table-wrap";
      const t=document.createElement("table"); const thead=document.createElement("thead"), tbody=document.createElement("tbody");
      thead.innerHTML=`<tr>${columns.map(c=>`<th>${c.label}</th>`).join("")}</tr>`;
      rows.forEach(r=>{
        const tr=document.createElement("tr");
        tr.innerHTML=columns.map(c=>`<td>${(c.render?c.render(r):r[c.key]) ?? ""}</td>`).join("");
        tbody.appendChild(tr);
      });
      t.appendChild(thead); t.appendChild(tbody); wrap.appendChild(t); return wrap;
    };
    const d = s => s ? new Date(s).toLocaleString() : "";
    // show silent JS errors in a badge
    window.addEventListener("error", e=>addBadge(`JS: ${e.message}`,"err"));
    window.addEventListener("unhandledrejection", e=>addBadge(`Promise: ${(e.reason && (e.reason.message||e.reason))||e}`,"err"));
    // ---- date helpers for observation window ----
    function toIso(dt) {
      const d = new Date(dt);
      // normalize to Z without ms
      return new Date(d.getTime() - d.getTimezoneOffset()*60000)
        .toISOString().replace(/\.\d{3}Z$/, 'Z');
    }
    function daysAgo(n){
      const d = new Date(); d.setDate(d.getDate()-n); return d;
    }
    // ---- charts helpers ----
    function sparkline(el, labels, values){
      return new Chart(el.getContext('2d'), {
        type: 'line',
        data: { labels, datasets: [{ data: values, tension: 0.35, pointRadius: 0, borderWidth: 2, fill: false }]},
        options: {
          responsive:true, maintainAspectRatio:false,
          plugins:{ legend:{display:false}, tooltip:{enabled:true, callbacks:{label:(ctx)=>`${ctx.parsed.y}`}}},
          scales:{ x:{ display:false }, y:{ display:false } }
        }
      });
    }
    (async () => {
      try{
        statusEl.textContent = "Initializing SMART client‚Ä¶";
        const client = await FHIR.oauth2.ready();
        statusEl.textContent = "‚úì Authorized";
        addBadge("Connected","ok");
        
        const patientId = client.patient.id;
        const userId = client.userId;
        const serverUrl = client.state.serverUrl;
        
        /* ----- Gather basic data ----- */
        let lastEncounter = null;
        try{
          const encs = await client.request(`Encounter?patient=${patientId}&_sort=-date&_count=1`);
          if(encs.entry && encs.entry.length>0) lastEncounter = encs.entry[0].resource;
        }catch{}
        
        /* ----- Vitals (with Window & Chart) ----- */
        const vitalsMap = new Map();
        let obsWindow = null;
        let observationsRows = [];
        
        if(lastEncounter && lastEncounter.period && lastEncounter.period.start){
          const encStart = new Date(lastEncounter.period.start);
          const windowStart = new Date(encStart.getTime() - 24*60*60*1000);
          const windowEnd = lastEncounter.period.end ? new Date(lastEncounter.period.end) : new Date();
          obsWindow = { start: windowStart, end: windowEnd };
          
          try{
            const searchParams = [
              `patient=${patientId}`,
              `date=ge${toIso(windowStart)}`,
              `date=le${toIso(windowEnd)}`,
              `_count=200`,
              `_sort=-date`
            ].join('&');
            
            const obsResp = await client.request(`Observation?${searchParams}`);
            (obsResp.entry||[]).forEach(e=>{
              const o = e.resource;
              const name = o.code?.text || o.code?.coding?.[0]?.display || "Unknown";
              const val = o.valueQuantity
                ? `${o.valueQuantity.value} ${o.valueQuantity.unit||""}`
                : (o.valueString || o.valueCodeableConcept?.text || "‚Äî");
              observationsRows.push({
                id: o.id,
                name: name,
                value: val,
                when: o.effectiveDateTime||o.issued||""
              });
              
              // collect for vitals
              const code = o.code?.coding?.[0]?.code;
              if(code && o.valueQuantity && o.valueQuantity.value!=null){
                if(!vitalsMap.has(code)) vitalsMap.set(code, {name, unit:o.valueQuantity.unit, readings:[]});
                vitalsMap.get(code).readings.push({
                  date: new Date(o.effectiveDateTime||o.issued),
                  value: o.valueQuantity.value
                });
              }
            });
          }catch{}
        }
        
        // vitals card
        if(vitalsMap.size>0){
          const vCard = card("Vitals Trends","üíì","span-5");
          const vgrid = document.createElement("div"); vgrid.className="vital-grid"; vCard.appendChild(vgrid);
          vitalsMap.forEach((v,code)=>{
            v.readings.sort((a,b)=>a.date-b.date);
            const latest = v.readings[v.readings.length-1];
            const vDiv = document.createElement("div"); vDiv.className="vital";
            const label = document.createElement("div"); label.className="v-label";
            const vName = document.createElement("div"); vName.className="v-name"; vName.textContent=v.name;
            const vNow = document.createElement("div"); vNow.className="v-now"; 
            vNow.textContent=`${latest.value} ${v.unit||""}`;
            label.appendChild(vName); label.appendChild(vNow); vDiv.appendChild(label);
            const meta = document.createElement("div"); meta.className="v-meta";
            meta.textContent=`${v.readings.length} reading(s)`;
            vDiv.appendChild(meta);
            
            if(v.readings.length>1){
              const chartWrap = document.createElement("div"); chartWrap.className="chart-wrap";
              const canvas = document.createElement("canvas");
              chartWrap.appendChild(canvas); vDiv.appendChild(chartWrap);
              const labels = v.readings.map(r=>r.date.toLocaleDateString());
              const values = v.readings.map(r=>r.value);
              sparkline(canvas, labels, values);
            }
            vgrid.appendChild(vDiv);
          });
        }
        
        /* ----- Server Capabilities ----- */
        try{
          const meta = await client.request("metadata");
          const impl = meta.implementation?.description || meta.software?.name || "‚Äî";
          const c = card("Server Info","‚öôÔ∏è","span-4");
          c.appendChild(kv([
            ["FHIR Server", `<span class="mono">${serverUrl}</span>`],
            ["Software", impl],
            ["FHIR Version", meta.fhirVersion || "‚Äî"],
          ]));
        }catch{
          addBadge("Server metadata failed","warn");
        }
        
        /* ----- Patient ----- */
        if(patientId){
          try{
            const p = await client.request(`Patient/${patientId}`);
            const name = `${(p.name?.[0]?.given||[]).join(" ")} ${p.name?.[0]?.family||""}`.trim();
            const c = card("Patient","üë§","span-4");
            c.appendChild(kv([
              ["ID", `<span class="mono">Patient/${p.id}</span>`],
              ["Name", name || "‚Äî"],
              ["DOB", p.birthDate || "‚Äî"],
              ["Gender", p.gender || "‚Äî"],
            ]));
          }catch{ addBadge("Patient read failed","err"); }
        }
        
        /* ----- Last Encounter ----- */
        if(lastEncounter){
          const c = card("Last Encounter","üè•","span-4");
          c.appendChild(kv([
            ["ID", `<span class="mono">Encounter/${lastEncounter.id}</span>`],
            ["Status", lastEncounter.status || "‚Äî"],
            ["Class", (lastEncounter.class?.display||lastEncounter.class?.code) || "‚Äî"],
            ["Type", (lastEncounter.type||[]).map(t=>t.coding?.[0]?.display||t.text).filter(Boolean).join(", ") || "‚Äî"],
            ["Start", d(lastEncounter.period?.start) || "‚Äî"],
            ["End", d(lastEncounter.period?.end) || "‚Äî"],
            ["Location", (lastEncounter.location||[]).map(l=>l.location?.display).filter(Boolean).join(", ") || "‚Äî"]
          ]));
        } else { 
          addBadge("No encounters","warn"); 
        }
        
        /* ----- Observations (Last Encounter) ----- */
        if (observationsRows.length > 0) {
          const c = card("Observations (Last Encounter)","üìà","span-7");
          c.appendChild(tbl(
            [
              {key:"id",label:"ID",render:r=>`<span class="mono">${r.id}</span>`},
              {key:"name",label:"Observation"},
              {key:"value",label:"Value"},
              {key:"when",label:"When",render:r=>d(r.when)}
            ],
            observationsRows
          ));
          if(obsWindow){
            const hint = document.createElement("div");
            hint.className = "empty";
            hint.textContent = `Window: ${obsWindow.start ? obsWindow.start.toLocaleString() : "‚Äî"} ‚Üí ${obsWindow.end ? obsWindow.end.toLocaleString() : "‚Äî"}`;
            c.appendChild(hint);
          }
        }
        
        /* ----- Billing (ChargeItem) ----- */
        const billingCard = card("Billing (ChargeItem)","üí≥","span-6");
        
        // Function to create sample ChargeItems
        async function createSampleChargeItems() {
          if (!lastEncounter?.id) {
            addBadge("No encounter for ChargeItem", "warn");
            return false;
          }

          const sampleCharges = [
            {
              code: "99213",
              display: "Office Visit - Established Patient",
              system: "http://www.ama-assn.org/go/cpt",
              price: 150.00
            },
            {
              code: "80053",
              display: "Comprehensive Metabolic Panel",
              system: "http://www.ama-assn.org/go/cpt",
              price: 45.00
            },
            {
              code: "36415",
              display: "Venipuncture",
              system: "http://www.ama-assn.org/go/cpt",
              price: 15.00
            }
          ];

          let created = 0;
          for (const charge of sampleCharges) {
            const chargeItem = {
              resourceType: "ChargeItem",
              status: "billable",
              subject: {
                reference: `Patient/${patientId}`
              },
              context: {
                reference: `Encounter/${lastEncounter.id}`
              },
              code: {
                coding: [{
                  system: charge.system,
                  code: charge.code,
                  display: charge.display
                }]
              },
              occurrenceDateTime: new Date().toISOString(),
              quantity: {
                value: 1
              },
              priceOverride: {
                value: charge.price,
                currency: "USD"
              },
              identifier: [{
                system: "https://smart-claims-demo",
                value: `demo-${Date.now()}-${created}`
              }]
            };

            try {
              await client.create(chargeItem);
              created++;
            } catch (error) {
              console.error(`Failed to create ${charge.display}:`, error);
            }
          }

          return created > 0;
        }

        const showOutcome = oo => {
          const text = (oo?.issue||[]).map(i=>i.details?.text||i.diagnostics||i.code).filter(Boolean).join(" ¬∑ ");
          const info = document.createElement("div");
          info.className = "empty";
          info.style.marginTop = "10px";
          info.innerHTML = `<span class="mono">${text||"No ChargeItems found via encounter or account."}</span>`;
          billingCard.appendChild(info);
        };
        
        try{
          let chargeItems = [], lastOutcome=null;
          
          // Try to fetch existing ChargeItems
          if(lastEncounter?.id){
            try{
              const r = await client.request(
                `ChargeItem?context=Encounter/${lastEncounter.id}` +
                `&_elements=id,code,subject,context,account,occurrenceDateTime&_count=50`,
                { flat:false }
              );
              (r.entry||[]).forEach(e=>chargeItems.push(e.resource));
            }catch(e){ lastOutcome = e?.response; }
          }
          if(!chargeItems.length && lastEncounter?.id){
            try{
              const r = await client.request(
                `ChargeItem?context=${lastEncounter.id}` +
                `&_elements=id,code,subject,context,account,occurrenceDateTime&_count=50`,
                { flat:false }
              );
              (r.entry||[]).forEach(e=>chargeItems.push(e.resource));
            }catch(e){ lastOutcome = e?.response; }
          }
          if(!chargeItems.length){
            try{
              const accts = await client.request(`Account?patient=${patientId}&_elements=id&_count=10`);
              const ids = (accts.entry||[]).map(e=>e.resource?.id).filter(Boolean);
              for(const id of ids){
                const r = await client.request(
                  `ChargeItem?account=Account/${id}` +
                  `&_elements=id,code,subject,context,account,occurrenceDateTime&_count=50`,
                  { flat:false }
                );
                (r.entry||[]).forEach(e=>chargeItems.push(e.resource));
              }
            }catch(e){ lastOutcome = e?.response; }
          }
          
          // Display ChargeItems if found
          if(chargeItems.length){
            const rows = chargeItems.map(ci=>({
              id: ci.id,
              codes: (ci.code?.coding||[]).map(c=>c.display||c.code).filter(Boolean).join(", "),
              when: ci.occurrenceDateTime || ci.effectiveTime || "",
              context: ci.context?.reference || "",
              account: (ci.account||[]).map(a=>a.reference).join(", ")
            }));
            billingCard.appendChild(
              tbl(
                [
                  {key:"id",label:"ChargeItem",render:r=>`<span class="mono">${r.id}</span>`},
                  {key:"codes",label:"Code(s)"},
                  {key:"when",label:"When",render:r=>d(r.when)},
                  {key:"context",label:"Context"},
                  {key:"account",label:"Account"},
                ],
                rows
              )
            );
          } else {
            // No ChargeItems found - show info and create button
            if (lastOutcome) {
              try { showOutcome(await lastOutcome.json()); } catch { showOutcome(null); }
            } else {
              showOutcome(null);
            }
            
            // Add note about creating data
            if (lastEncounter?.id) {
              const note = document.createElement("div");
              note.className = "empty";
              note.style.marginTop = "10px";
              note.style.padding = "12px";
              note.style.background = "#f0f9ff";
              note.style.border = "1px solid #bfdbfe";
              note.style.borderRadius = "8px";
              note.innerHTML = `
                <strong style="color:#1e40af">üí° Tip:</strong> Since ChargeItem data doesn't exist in this sandbox, 
                you can create sample billing data for testing purposes.
              `;
              billingCard.appendChild(note);
              
              // Add create button
              const createBtn = document.createElement("button");
              createBtn.textContent = "‚ûï Create Demo ChargeItems";
              createBtn.style.cssText = `
                margin-top: 12px;
                padding: 10px 20px;
                background: linear-gradient(90deg, var(--accent), var(--accent-2));
                color: white;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 600;
                font-size: 14px;
                box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
                transition: all 0.2s;
              `;
              createBtn.onmouseover = () => {
                createBtn.style.transform = "translateY(-2px)";
                createBtn.style.boxShadow = "0 6px 16px rgba(59, 130, 246, 0.4)";
              };
              createBtn.onmouseout = () => {
                createBtn.style.transform = "translateY(0)";
                createBtn.style.boxShadow = "0 4px 12px rgba(59, 130, 246, 0.3)";
              };
              createBtn.onclick = async () => {
                createBtn.disabled = true;
                createBtn.textContent = "‚è≥ Creating ChargeItems...";
                createBtn.style.cursor = "wait";
                
                try {
                  const success = await createSampleChargeItems();
                  
                  if (success) {
                    createBtn.textContent = "‚úÖ Created! Reloading...";
                    createBtn.style.background = "linear-gradient(90deg, var(--ok), var(--ok))";
                    addBadge("ChargeItems created", "ok");
                    setTimeout(() => location.reload(), 1500);
                  } else {
                    createBtn.textContent = "‚ùå Creation Failed";
                    createBtn.style.background = "linear-gradient(90deg, var(--err), var(--err))";
                    addBadge("ChargeItem creation failed", "err");
                    createBtn.disabled = false;
                    createBtn.style.cursor = "pointer";
                  }
                } catch (error) {
                  console.error("ChargeItem creation error:", error);
                  createBtn.textContent = "‚ùå Error: " + error.message;
                  createBtn.style.background = "linear-gradient(90deg, var(--err), var(--err))";
                  addBadge("ChargeItem POST failed", "err");
                  
                  // Show error details
                  const errDiv = document.createElement("div");
                  errDiv.className = "empty";
                  errDiv.style.marginTop = "10px";
                  errDiv.style.padding = "10px";
                  errDiv.style.background = "#fef2f2";
                  errDiv.style.border = "1px solid #fecaca";
                  errDiv.style.borderRadius = "6px";
                  errDiv.style.color = "#991b1b";
                  errDiv.innerHTML = `
                    <strong>Error:</strong> ${error.message}<br>
                    <small>This may mean POST ChargeItem is not supported in this sandbox.</small>
                  `;
                  billingCard.appendChild(errDiv);
                  
                  createBtn.disabled = false;
                  createBtn.style.cursor = "pointer";
                }
              };
              billingCard.appendChild(createBtn);
            }
          }
        }catch(e){
          billingCard.appendChild(kv([["Error", e.message]]));
        }
        
        /* ----- Orders (ServiceRequest) ----- */
        try{
          const r = await client.request(`ServiceRequest?patient=${patientId}&_count=20`);
          const rows = (r.entry||[]).map(e=>e.resource).map(x=>({
            id:x.id, code:x.code?.coding?.[0]?.display||x.code?.text||"",
            status:x.status||"", intent:x.intent||"", priority:x.priority||"",
            authoredOn:x.authoredOn||""
          }));
          const c = card("Orders (ServiceRequest)","üìù","span-6");
          c.appendChild(tbl(
            [
              {key:"id",label:"ID",render:r=>`<span class="mono">${r.id}</span>`},
              {key:"code",label:"Order"},
              {key:"status",label:"Status"},
              {key:"intent",label:"Intent"},
              {key:"priority",label:"Priority"},
              {key:"authoredOn",label:"Authored",render:r=>d(r.authoredOn)}
            ],
            rows
          ));
        }catch{}
        
        /* ----- Diagnostic Reports ----- */
        try{
          const r = await client.request(`DiagnosticReport?patient=${patientId}&_count=20`);
          const rows = (r.entry||[]).map(e=>e.resource).map(x=>({
            id:x.id, code:x.code?.coding?.[0]?.display||x.code?.text||"",
            status:x.status||"", when:x.issued||x.effectiveDateTime||""
          }));
          const c = card("Diagnostic Reports","üß™","span-6");
          c.appendChild(tbl(
            [
              {key:"id",label:"ID",render:r=>`<span class="mono">${r.id}</span>`},
              {key:"code",label:"Report"},
              {key:"status",label:"Status"},
              {key:"when",label:"When",render:r=>d(r.when)}
            ],
            rows
          ));
        }catch{}
        
        /* ----- Coverage ----- */
        try{
          const r = await client.request(`Coverage?patient=${patientId}&_count=5`);
          const rows = (r.entry||[]).map(e=>e.resource).map(c=>({
            id:c.id, status:c.status||"", payor:(c.payor||[]).map(p=>p.display||p.reference).join(", ")
          }));
          const c = card("Coverage","üõ°Ô∏è","span-6");
          c.appendChild(tbl(
            [
              {key:"id",label:"ID",render:r=>`<span class="mono">${r.id}</span>`},
              {key:"status",label:"Status"},
              {key:"payor",label:"Payor"}
            ],
            rows
          ));
        }catch{}
      }catch(err){
        statusEl.textContent = "‚ùå Initialization failed";
        addBadge(err.message,"err");
      }
    })();
  </script>
</body>
</html>
