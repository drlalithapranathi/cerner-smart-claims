<!DOCTYPE html>
<html lang="en">
<head>
Â  <meta charset="utf-8" />
Â  <title>Smart Claims â€“ Callback</title>
Â  <meta name="viewport" content="width=device-width, initial-scale=1" />
Â  <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.min.js"></script>
Â  Â  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

Â  Â  <style>
Â  Â  :root{
Â  Â  Â  /* Light vibrant theme */
Â  Â  Â  --bg1:#f7fbff;
Â  Â  Â  --bg2:#eef4ff;
Â  Â  Â  --panel:rgba(255,255,255,0.88);
Â  Â  Â  --panel-blur:10px;
Â  Â  Â  --text:#0b1220;
Â  Â  Â  --muted:#657094;
Â  Â  Â  --border:#e6ecff;
Â  Â  Â  --ok:#12b886;
Â  Â  Â  --warn:#f59f00;
Â  Â  Â  --err:#e03131;
Â  Â  Â  --hdr:#f2f5ff;
Â  Â  Â  --accent:#3b82f6;
Â  Â  Â  --accent-2:#8b5cf6;
Â  Â  Â  --chip:#eef2ff;
Â  Â  Â  --shadow:0 18px 40px rgba(30,55,135,.12), 0 4px 14px rgba(30,55,135,.06);
Â  Â  Â  --radius:16px;
Â  Â  }

Â  Â  *{box-sizing:border-box}
Â  Â  html,body{height:100%}
Â  Â  body{
Â  Â  Â  margin:0; padding:26px;
Â  Â  Â  background:
Â  Â  Â  Â  radial-gradient(1200px 800px at -10% -20%, #e9f6ff 10%, transparent 60%),
Â  Â  Â  Â  radial-gradient(1200px 800px at 110% -10%, #f0eaff 10%, transparent 60%),
Â  Â  Â  Â  linear-gradient(180deg,var(--bg1),var(--bg2));
Â  Â  Â  color:var(--text);
Â  Â  Â  font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Inter, Arial, sans-serif;
Â  Â  }

Â  Â  header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:20px}
Â  Â  .app-title{font-weight:900;letter-spacing:.2px;font-size:clamp(24px,2.6vw,34px);background:linear-gradient(90deg,#0f172a,#334155);-webkit-background-clip:text;background-clip:text;color:transparent}
Â  Â  .subtitle{color:var(--muted);font-size:.95rem}

Â  Â  .chips{display:flex;flex-wrap:wrap;gap:8px}
Â  Â  .badge{
Â  Â  Â  display:inline-flex;align-items:center;gap:6px;
Â  Â  Â  padding:6px 12px;border-radius:999px;
Â  Â  Â  background:var(--chip);border:1px solid var(--border);
Â  Â  Â  font-size:.8rem;color:#334155; backdrop-filter:saturate(130%) blur(6px)
Â  Â  }
Â  Â  .badge.ok{color:var(--ok)} .badge.warn{color:var(--warn)} .badge.err{color:var(--err)}

Â  Â  .grid{display:grid;gap:18px;grid-template-columns:repeat(12,1fr)}
Â  Â  @media (max-width:980px){.grid{grid-template-columns:repeat(6,1fr)}}
Â  Â  @media (max-width:640px){.grid{grid-template-columns:repeat(1,1fr)}}
Â  Â  .span-4{grid-column:span 4} .span-5{grid-column:span 5}
Â  Â  .span-6{grid-column:span 6} .span-7{grid-column:span 7}
Â  Â  .span-8{grid-column:span 8} .span-12{grid-column:span 12}

Â  Â  .card{
Â  Â  Â  position:relative;
Â  Â  Â  background:var(--panel);
Â  Â  Â  border:1px solid var(--border);
Â  Â  Â  border-radius:var(--radius);
Â  Â  Â  padding:16px 16px 10px;
Â  Â  Â  box-shadow:var(--shadow);
Â  Â  Â  backdrop-filter: blur(var(--panel-blur));
Â  Â  Â  transform: translateZ(0);
Â  Â  Â  overflow:hidden;
Â  Â  }
Â  Â  /* soft corner sheen */
Â  Â  .card::after{
Â  Â  Â  content:"";
Â  Â  Â  position:absolute; inset:-1px -1px auto auto;
Â  Â  Â  width:180px; height:180px; border-radius:50%;
Â  Â  Â  background: radial-gradient(closest-side,rgba(139,92,246,.10),transparent 80%);
Â  Â  Â  filter: blur(8px); pointer-events:none;
Â  Â  Â  transform: translate(40%, -40%);
Â  Â  }

Â  Â  .card h3{margin:0 0 12px; font-size:1rem; font-weight:800; letter-spacing:.2px; display:flex; align-items:center; gap:10px}

Â  Â  .kv{
Â  Â  Â  display:grid; grid-template-columns: 140px 1fr;
Â  Â  Â  gap:8px 12px; font-size:.95rem; word-break:break-word;
Â  Â  }
Â  Â  .kv b{ color:#334155; font-weight:700; align-self:start }
Â  Â  .kv .mono{ white-space:pre-wrap; word-break:break-all }

Â  Â  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; color:#0f172a}

Â  Â  .table-wrap{max-height:420px;overflow:auto;border-radius:12px;border:1px solid var(--border);background:#fff}
Â  Â  table{width:100%;border-collapse:collapse;font-size:.92rem}
Â  Â  thead th{position:sticky;top:0;background:linear-gradient(180deg,var(--hdr),#ffffff);color:#334155;text-align:left;border-bottom:1px solid var(--border);padding:10px 12px}
Â  Â  tbody td{padding:10px 12px;border-bottom:1px solid var(--border)}
Â  Â  tbody tr:hover td{background:linear-gradient(90deg,#f7faff,#ffffff)}

Â  Â  .muted{color:var(--muted)}
Â  Â  .empty{padding:8px 0;color:var(--muted)}

Â  Â  a.link{color:var(--accent); text-decoration:none}
Â  Â  a.link:hover{text-decoration:underline}

Â  Â  /* vitals cards */
Â  Â  .vital-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
Â  Â  @media (max-width:980px){.vital-grid{grid-template-columns:repeat(2,1fr)}}
Â  Â  @media (max-width:540px){.vital-grid{grid-template-columns:1fr}}
Â  Â  .vital{
Â  Â  Â  background:#fff;border:1px solid var(--border);border-radius:14px;padding:10px 12px;
Â  Â  Â  box-shadow:0 8px 16px rgba(59,130,246,.08);
Â  Â  }
Â  Â  .v-label{display:flex; align-items:baseline; gap:8px; margin-bottom:4px}
Â  Â  .v-name{font-weight:700}
Â  Â  .v-now{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; color:#111827}
Â  Â  .v-meta{font-size:.8rem;color:var(--muted)}
Â  Â  canvas{width:100%; height:80px}
Â  </style>
</head>
<body>
Â  <header>
Â  Â  <div>
Â  Â  Â  <div class="app-title">Smart Claims</div>
Â  Â  Â  <div id="status" class="subtitle">Completing SMART sign-inâ€¦</div>
Â  Â  </div>
Â  Â  <div id="badges" class="chips"></div>
Â  </header>

Â  <div id="grid" class="grid"></div>

Â  <script>
Â  Â  // ---------- small view helpers ----------
Â  Â  const grid = document.getElementById("grid");
Â  Â  const badges = document.getElementById("badges");
Â  Â  const statusEl = document.getElementById("status");

Â  Â  const addBadge = (text, type="")=>{
Â  Â  Â  const b=document.createElement("span"); b.className=`badge ${type}`; b.textContent=text; badges.appendChild(b);
Â  Â  };
Â  Â  const card = (title, icon, span="span-4")=>{
Â  Â  Â  const c=document.createElement("div"); c.className=`card ${span}`;
Â  Â  Â  c.innerHTML=`<h3>${icon||""} ${title}</h3>`; grid.appendChild(c); return c;
Â  Â  };
Â  Â  const kv = pairs=>{
Â  Â  Â  const wrap=document.createElement("div"); wrap.className="kv";
Â  Â  Â  for(const [k,v] of pairs){
Â  Â  Â  Â  const kEl=document.createElement("b"); kEl.textContent=k;
Â  Â  Â  Â  const vEl=document.createElement("div"); vEl.innerHTML=v ?? "<span class='muted'>â€”</span>";
Â  Â  Â  Â  wrap.appendChild(kEl); wrap.appendChild(vEl);
Â  Â  Â  }
Â  Â  Â  return wrap;
Â  Â  };
Â  Â  const tbl = (columns, rows)=>{
Â  Â  Â  if(!rows.length){const d=document.createElement("div"); d.className="empty"; d.textContent="No data"; return d;}
Â  Â  Â  const wrap=document.createElement("div"); wrap.className="table-wrap";
Â  Â  Â  const t=document.createElement("table"); const thead=document.createElement("thead"), tbody=document.createElement("tbody");
Â  Â  Â  thead.innerHTML=`<tr>${columns.map(c=>`<th>${c.label}</th>`).join("")}</tr>`;
Â  Â  Â  rows.forEach(r=>{
Â  Â  Â  Â  const tr=document.createElement("tr");
Â  Â  Â  Â  tr.innerHTML=columns.map(c=>`<td>${(c.render?c.render(r):r[c.key]) ?? ""}</td>`).join("");
Â  Â  Â  Â  tbody.appendChild(tr);
Â  Â  Â  });
Â  Â  Â  t.appendChild(thead); t.appendChild(tbody); wrap.appendChild(t); return wrap;
Â  Â  };
Â  Â  const d = s => s ? new Date(s).toLocaleString() : "";

Â  Â  // show silent JS errors in a badge
Â  Â  window.addEventListener("error", e=>addBadge(`JS: ${e.message}`,"err"));
Â  Â  window.addEventListener("unhandledrejection", e=>addBadge(`Promise: ${(e.reason && (e.reason.message||e.reason))||e}`,"err"));

Â  Â  // ---- date helpers for observation window ----
Â  Â  function toIso(dt) {
Â  Â  Â  const d = new Date(dt);
Â  Â  Â  // normalize to Z without ms
Â  Â  Â  return new Date(d.getTime() - d.getTimezoneOffset()*60000)
Â  Â  Â  Â  .toISOString().replace(/\.\d{3}Z$/, 'Z');
Â  Â  }
Â  Â  function daysAgo(n){
Â  Â  Â  const d = new Date(); d.setDate(d.getDate()-n); return d;
Â  Â  }

Â  Â  // ---- charts helpers ----
Â  Â  function sparkline(el, labels, values){
Â  Â  Â  return new Chart(el.getContext('2d'), {
Â  Â  Â  Â  type: 'line',
Â  Â  Â  Â  data: { labels, datasets: [{ data: values, tension: 0.35, pointRadius: 0, borderWidth: 2, fill: false }]},
Â  Â  Â  Â  options: {
Â  Â  Â  Â  Â  responsive:true, maintainAspectRatio:false,
Â  Â  Â  Â  Â  plugins:{ legend:{display:false}, tooltip:{enabled:true, callbacks:{label:(ctx)=>`${ctx.parsed.y}`}}},
Â  Â  Â  Â  Â  scales:{ x:{ display:false }, y:{ display:false } }
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  }

Â  Â  (async () => {
Â  Â  Â  const client = await FHIR.oauth2.ready();
Â  Â  Â  statusEl.textContent = "Connected";
Â  Â  Â  const token = client.state?.tokenResponse || {};
Â  Â  Â  addBadge("SMART OK","ok");
Â  Â  Â  addBadge(`scope:${String(token.scope||"").split(" ").length}`,"");
Â  Â  Â  addBadge(`exp:${Math.round((token.expires_in||0)/60)}m`,"");

Â  Â  Â  /* ----- Server Info ----- */
Â  Â  Â  try{
Â  Â  Â  Â  const meta = await client.request("metadata");
Â  Â  Â  Â  const serverUrl = (client.state?.serverUrl || "").replace(/\/$/,"");
Â  Â  Â  Â  const c = card("Server Info","ğŸ›°ï¸","span-4");
Â  Â  Â  Â  c.appendChild(kv([
Â  Â  Â  Â  Â  ["FHIR Version", `<span class="mono">${meta.fhirVersion || "4.x"}</span>`],
Â  Â  Â  Â  Â  ["Server", serverUrl ? `<a href="${serverUrl}" target="_blank" rel="noopener" class="mono link">${serverUrl}</a>` : "â€”"],
Â  Â  Â  Â  Â  ["Status", meta.status || "unknown"]
Â  Â  Â  Â  ]));
Â  Â  Â  }catch{
Â  Â  Â  Â  addBadge("Server metadata failed","warn");
Â  Â  Â  }

Â  Â  Â  /* ----- Patient ----- */
Â  Â  Â  let patientId = client.patient?.id || null;
Â  Â  Â  if(!patientId){
Â  Â  Â  Â  try{
Â  Â  Â  Â  Â  const b = await client.request("Patient?_count=1");
Â  Â  Â  Â  Â  patientId = b.entry?.[0]?.resource?.id || null;
Â  Â  Â  Â  Â  addBadge("No launch context â†’ using first patient","warn");
Â  Â  Â  Â  }catch{ addBadge("Patient lookup failed","err"); }
Â  Â  Â  }

Â  Â  Â  if(patientId){
Â  Â  Â  Â  try{
Â  Â  Â  Â  Â  const p = await client.request(`Patient/${patientId}`);
Â  Â  Â  Â  Â  const name = `${(p.name?.[0]?.given||[]).join(" ")} ${p.name?.[0]?.family||""}`.trim();
	 Â  Â  const c = card("Patient","ğŸ‘¤","span-4");
Â  Â  Â  Â  Â  c.appendChild(kv([
Â  Â  Â  Â  Â  Â  ["ID", `<span class="mono">Patient/${p.id}</span>`],
Â  Â  Â  Â  Â  Â  ["Name", name || "â€”"],
Â  Â  Â  Â  Â  Â  ["DOB", p.birthDate || "â€”"],
Â  Â  Â  Â  Â  Â  ["Gender", p.gender || "â€”"],
Â  Â  Â  Â  Â  ]));
Â  Â  Â  Â  }catch{ addBadge("Patient read failed","err"); }
Â  Â  Â  }

Â  Â  Â  /* ----- Last Encounter ----- */
Â  Â  Â  let lastEncounter=null;
Â  Â  Â  try{
Â  Â  Â  Â  const encs = await client.request(`Encounter?patient=${patientId}&_sort=-date&_count=1`);
Â  Â  Â  Â  if(encs.entry?.length){
Â  Â  Â  Â  Â  lastEncounter = encs.entry[0].resource;
Â  Â  Â  Â  Â  const c = card("Last Encounter","ğŸ¥","span-4");
Â  Â  Â  Â  Â  c.appendChild(kv([
Â  Â  Â  Â  Â  Â  ["ID", `<span class="mono">Encounter/${lastEncounter.id}</span>`],
Â  Â  Â  Â  Â  Â  ["Status", lastEncounter.status || "â€”"],
Â  Â  Â  Â  Â  Â  ["Class", (lastEncounter.class?.display||lastEncounter.class?.code) || "â€”"],
Â  Â  Â  Â  Â  Â  ["Type", (lastEncounter.type||[]).map(t=>t.coding?.[0]?.display||t.text).filter(Boolean).join(", ") || "â€”"],
Â  Â  Â  Â  Â  Â  ["Start", d(lastEncounter.period?.start) || "â€”"],
Â  Â  Â  Â  Â  Â  ["End", d(lastEncounter.period?.end) || "â€”"],
Â  Â  Â  Â  Â  Â  ["Location", (lastEncounter.location||[]).map(l=>l.location?.display).filter(Boolean).join(", ") || "â€”"]
Â  Â  Â  Â  Â  ]));
Â  Â  Â  Â  } else { addBadge("No encounters","warn"); }
Â  Â  Â  }catch{ addBadge("Encounter query failed","err"); }

Â  Â  Â  /* ----- Billing (ChargeItem) ----- */
Â  Â  Â  const billingCard = card("Billing (ChargeItem)","ğŸ’³","span-6");
Â  Â  Â  const showOutcome = oo => {
Â  Â  Â  Â  const text = (oo?.issue||[]).map(i=>i.details?.text||i.diagnostics||i.code).filter(Boolean).join(" Â· ");
Â  Â  Â  Â  billingCard.appendChild(kv([["Info", `<span class="mono">${text||"No ChargeItems found via encounter or account."}</span>`]]));
Â  Â  Â  };

Â  Â  Â  try{
Â  Â  Â  Â  let chargeItems = [], lastOutcome=null;

Â  Â  Â  Â  if(lastEncounter?.id){
Â  Â  Â  Â  Â  try{
Â  Â  Â  Â  Â  Â  const r = await client.request(
Â  Â  Â  Â  Â  Â  Â  `ChargeItem?context=Encounter/${lastEncounter.id}` +
Â  Â  Â  Â  Â  Â  Â  `&_elements=id,code,subject,context,account,occurrenceDateTime&_count=50`,
Â  Â  Â  Â  Â  Â  Â  { flat:false }
Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  (r.entry||[]).forEach(e=>chargeItems.push(e.resource));
Â  Â  Â  Â  Â  }catch(e){ lastOutcome = e?.response; }
Â  Â  Â  Â  }

Â  Â  Â  Â  if(!chargeItems.length && lastEncounter?.id){
Â  Â  Â  Â  Â  try{
Â  Â  Â  Â  Â  Â  const r = await client.request(
Â  Â  Â  Â  Â  Â  Â  `ChargeItem?context=${lastEncounter.id}` +
Â  Â  Â  Â  Â  Â  Â  `&_elements=id,code,subject,context,account,occurrenceDateTime&_count=50`,
Â  Â  Â  Â  Â  Â  Â  { flat:false }
Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  (r.entry||[]).forEach(e=>chargeItems.push(e.resource));
Â  Â  Â  Â  Â  }catch(e){ lastOutcome = e?.response; }
Â  Â  Â  Â  }

Â  Â  Â  Â  if(!chargeItems.length){
Â  Â  Â  Â  Â  try{
Â  Â  Â  Â  Â  Â  const accts = await client.request(`Account?patient=${patientId}&_elements=id&_count=10`);
Â  Â  Â  Â  Â  Â  const ids = (accts.entry||[]).map(e=>e.resource?.id).filter(Boolean);
Â  Â  Â  Â  Â  Â  for(const id of ids){
Â  Â  Â  Â  Â  Â  Â  const r = await client.request(
Â  Â  Â  Â  Â  Â  Â  Â  `ChargeItem?account=Account/${id}` +
Â  Â  Â  Â  Â  Â  Â  Â  `&_elements=id,code,subject,context,account,occurrenceDateTime&_count=50`,
Â  Â  Â  Â  Â  Â  Â  Â  { flat:false }
Â  Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  Â  (r.entry||[]).forEach(e=>chargeItems.push(e.resource));
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }catch(e){ lastOutcome = e?.response; }
Â  Â  Â  Â  }

Â  Â  Â  Â  if(chargeItems.length){
Â  Â  Â  Â  Â  const rows = chargeItems.map(ci=>({
Â  Â  Â  Â  Â  Â  id: ci.id,
Â  Â  Â  Â  Â  Â  codes: (ci.code?.coding||[]).map(c=>c.display||c.code).filter(Boolean).join(", "),
Â  Â  Â  Â  Â  Â  when: ci.occurrenceDateTime || ci.effectiveTime || "",
Â  Â  Â  Â  Â  Â  context: ci.context?.reference || "",
Â  Â  Â  Â  Â  Â  account: (ci.account||[]).map(a=>a.reference).join(", ")
Â  Â  Â  Â  Â  }));
Â  Â  Â  Â  Â  billingCard.appendChild(
Â  Â  Â  Â  Â  Â  tbl(
Â  Â  Â  Â  Â  Â  Â  [
Â  Â  Â  Â  Â  Â  Â  Â  {key:"id",label:"ChargeItem",render:r=>`<span class="mono">${r.id}</span>`},
Â  Â  Â  Â  Â  Â  Â  Â  {key:"codes",label:"Code(s)"},
Â  Â  Â  Â  Â  Â  Â  Â  {key:"when",label:"When",render:r=>d(r.when)},
Â  Â  Â  Â  Â  Â  Â  Â  {key:"context",label:"Context"},
Â  Â  Â  Â  Â  Â  Â  Â  {key:"account",label:"Account"},
Â  Â  Â  Â  Â  Â  Â  ],
Â  Â  Â  Â  Â  Â  Â  rows
Â  Â  Â  Â  Â  Â  )
Â  Â  Â  Â  Â  );
Â  Â  Â  Â  } else if (lastOutcome) {
Â  Â  Â  Â  Â  try { showOutcome(await lastOutcome.json()); } catch { showOutcome(null); }
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  showOutcome(null);
Â  Â  Â  Â  }
Â  Â  Â  }catch(e){
	 Â  billingCard.appendChild(kv([["Error", e.message]]));
Â  Â  Â  }

Â  Â  Â  /* ----- Orders (ServiceRequest) ----- */
Â  Â  Â  try{
Â  Â  Â  Â  const r = await client.request(`ServiceRequest?patient=${patientId}&_count=20`);
Â  Â  Â  Â  const rows = (r.entry||[]).map(e=>e.resource).map(x=>({
Â  Â  Â  Â  Â  id:x.id, code:x.code?.coding?.[0]?.display||x.code?.text||"",
Â  Â  Â  Â  Â  status:x.status||"", intent:x.intent||"", priority:x.priority||"",
Â  Â  Â  Â  Â  authoredOn:x.authoredOn||""
Â  Â  Â  Â  }));
Â  Â  Â  Â  const c = card("Orders (ServiceRequest)","ğŸ“","span-6");
Â  Â  Â  Â  c.appendChild(tbl(
Â  Â  Â  Â  Â  [
Â  Â  Â  Â  Â  Â  {key:"id",label:"ID",render:r=>`<span class="mono">${r.id}</span>`},
Â  Â  Â  Â  Â  Â  {key:"code",label:"Order"},
Â  Â  Â  Â  Â  Â  {key:"status",label:"Status"},
Â  Â  Â  Â  Â  Â  {key:"intent",label:"Intent"},
Â  Â  Â  Â  Â  Â  {key:"priority",label:"Priority"},
Â  Â  Â  Â  Â  Â  {key:"authoredOn",label:"Authored",render:r=>d(r.authoredOn)}
Â  Â  Â  Â  Â  ],
Â  Â  Â  Â  Â  rows
Â  Â  Â  Â  ));
Â  Â  Â  }catch{}

Â  Â  Â  /* ----- Diagnostic Reports ----- */
Â  Â  Â  try{
Â  Â  Â  Â  const r = await client.request(`DiagnosticReport?patient=${patientId}&_count=20`);
Â  Â  Â  Â  const rows = (r.entry||[]).map(e=>e.resource).map(x=>({
Â  Â  Â  Â  Â  id:x.id, code:x.code?.coding?.[0]?.display||x.code?.text||"",
Â  Â  Â  Â  Â  status:x.status||"", when:x.issued||x.effectiveDateTime||""
Â  Â  Â  Â  }));
Â  Â  Â  Â  const c = card("Diagnostic Reports","ğŸ§ª","span-6");
Â  Â  Â  Â  c.appendChild(tbl(
Â  Â  Â  Â  Â  [
Â  Â  Â  Â  Â  Â  {key:"id",label:"ID",render:r=>`<span class="mono">${r.id}</span>`},
Â  Â  Â  Â  Â  Â  {key:"code",label:"Report"},
Â  Â  Â  Â  Â  Â  {key:"status",label:"Status"},
Â  Â  Â  Â  Â  Â  {key:"when",label:"When",render:r=>d(r.when)}
Â  Â  Â  Â  Â  ],
Â  Â  Â  Â  Â  rows
Â  Â  Â  Â  ));
Â  Â  Â  }catch{}

Â  Â  Â  /* ----- Observations (last encounter, time-filtered & sorted) ----- */
Â  Â  Â  let obsWindow = null, observationsRows = [];
Â  Â  Â  if (lastEncounter?.id) {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  let start = lastEncounter.period?.start ? new Date(lastEncounter.period.start) : null;
Â  Â  Â  Â  Â  let end Â  = lastEncounter.period?.end Â  ? new Date(lastEncounter.period.end) Â  : null;
Â  Â  Â  Â  Â  if (!start && !end) { end = new Date(); start = daysAgo(7); }
Â  Â  Â  Â  Â  else { if (start && !end) end = new Date(); if (!start && end) start = new Date(end.getTime() - 7*24*60*60*1000); }

Â  Â  Â  Â  Â  obsWindow = {start, end};

Â  Â  Â  Â  Â  const params = new URLSearchParams({
Â  Â  Â  Â  Â  Â  patient: String(patientId), encounter: String(lastEncounter.id),
Â  Â  Â  Â  Â  Â  _count: '50', _sort: '-date'
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  if (start) params.append('date', `ge${toIso(start)}`);
Â  Â  Â  Â  Â  if (end) Â  params.append('date', `le${toIso(end)}`);

Â  Â  Â  Â  Â  const url = `Observation?${params.toString()}`;
Â  Â  Â  Â  Â  const r = await client.request(url);

Â  Â  Â  Â  Â  observationsRows = (r.entry || []).map(e => e.resource).map(o => {
Â  Â  Â  Â  Â  Â  const value = (o.valueQuantity ? `${o.valueQuantity.value} ${o.valueQuantity.unit}` : null)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â || o.valueString || "";
Â  Â  Â  Â  Â  Â  return {
Â  Â  Â  Â  Â  Â  Â  id: o.id,
Â  Â  Â  Â  Â  Â  Â  name: o.code?.coding?.[0]?.display || o.code?.text || "",
Â  Â  Â  Â  Â  Â  Â  value,
Â  Â  Â  Â  Â  Â  Â  when: o.effectiveDateTime || o.issued || o.meta?.lastUpdated || "",
Â  Â  Â  Â  Â  Â  Â  loinc: (o.code?.coding||[]).find(c=>c.system==="http://loinc.org")?.code || ""
Â  Â  Â  Â  Â  Â  };
Â  Â  	 Â  Â  });

Â  Â  Â  Â  Â  const c = card("Observations (Last Encounter)","ğŸ“ˆ","span-7");
Â  Â  Â  Â  Â  c.appendChild(tbl(
Â  Â  Â  Â  Â  Â  [
Â  Â  Â  Â  Â  Â  Â  {key:"id",label:"ID",render:r=>`<span class="mono">${r.id}</span>`},
Â  Â  Â  Â  Â  Â  Â  {key:"name",label:"Observation"},
Â  Â  Â  Â  Â  Â  Â  {key:"value",label:"Value"},
Â  Â  Â  Â  Â  Â  Â  {key:"when",label:"When",render:r=>d(r.when)}
Â  Â  Â  Â  Â  Â  ],
Â  Â  Â  Â  Â  Â  observationsRows
Â  Â  Â  Â  Â  ));
Â  	 Â  Â  Â  const hint = document.createElement("div");
Â  Â  Â  Â  Â  hint.className = "empty";
Â  Â  Â  Â  Â  hint.textContent = `Window: ${obsWindow.start ? obsWindow.start.toLocaleString() : "â€”"} â†’ ${obsWindow.end ? obsWindow.end.toLocaleString() : "â€”"}`;
Â  Â  Â  Â  Â  c.appendChild(hint);
Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  const c = card("Observations (Last Encounter)","ğŸ“ˆ","span-7");
Â  Â  Â  Â  Â  c.appendChild(kv([["Error", e.message]]));
Â  Â  Â  Â  }
Â  Â  Â  }

Â  Â  Â  /* ----- Vitals (Sparkline visualizations from recent data) ----- */
Â  Â  Â  // Try to build nice visuals using last-encounter observations; if missing, fetch by code
Â  Â  Â  const vitals = [
Â  Â  Â  Â  { key:"hr", Â  name:"Heart Rate", Â  Â  Â  Â  loinc:["8867-4"], unitHint:"bpm" },
Â  Â  Â  Â  { key:"sbp", Â name:"Systolic BP", Â  Â  Â  Â loinc:["8480-6"], unitHint:"mmHg" },
Â  	 Â  Â  { key:"dbp", Â name:"Diastolic BP", Â  Â  Â  loinc:["8462-4"], unitHint:"mmHg" },
Â  Â  Â  Â  { key:"temp", name:"Body Temperature", Â  loinc:["8310-5"], unitHint:"Â°C/Â°F" },
Â  Â  Â  Â  { key:"spo2", name:"Oâ‚‚ Saturation", Â  Â  Â loinc:["59408-5","2708-6"], unitHint:"%" },
Â  Â  Â  ];

Â  Â  Â  function extractFromRows(codeList){
Â  Â  Â  Â  const rows = (observationsRows||[]).filter(r=>codeList.includes(r.loinc));
Â  Â  Â  Â  // newest first already; reverse for leftâ†’right time
Â  Â  Â  Â  const labels = rows.slice().reverse().map(r=>new Date(r.when).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}));
Â  Â  Â  Â  const values = rows.slice().reverse().map(r=>{
Â  Â  Â  Â  Â  const m = /(-?\d+(\.\d+)?)/.exec(r.value||""); return m? Number(m[1]) : null;
Â  	 Â  Â  }).filter(v => v!==null);
Â  Â  Â  Â  const latest = rows.length ? rows[0].value : null;
Â  Â  Â  Â  return {labels, values, latest};
Â  Â  Â  }

Â  Â  Â  async function fetchByLoinc(loincCodes){
Â  Â  Â  Â  // last 30 observations for any of the codes
Â  Â  Â  Â  const codeQP = loincCodes.map(c=>`code=http://loinc.org|${c}`).join("&");
Â  Â  Â  Â  const r = await client.request(`Observation?patient=${patientId}&${codeQP}&_sort=-date&_count=30`);
Â  Â  Â  Â  const items = (r.entry||[]).map(e=>e.resource);
Â  Â  Â  Â  return items.map(o=>({
Â  Â  Â  Â  Â  when: o.effectiveDateTime || o.issued || "",
Â  Â  Â  Â  Â  value: (o.valueQuantity ? `${o.valueQuantity.value} ${o.valueQuantity.unit}` : (o.valueString || "")),
Â  Â  Â  Â  }));
Â  Â  Â  }

Â  Â  Â  const vitalsCard = card("Vitals (Trends)","ğŸ’ ","span-5");
Â  Â  Â  const gridBox = document.createElement('div');
Â  Â  Â  gridBox.className = 'vital-grid';
Â  Â  Â  vitalsCard.appendChild(gridBox);

Â  Â  Â  for (const v of vitals){
Â  Â  Â  Â  let {labels, values, latest} = extractFromRows(v.loinc);

Â  Â  Â  Â  // If encounter-filtered data was too thin, try patient-wide recent
Â  Â  Â  Â  if ((!values || values.length<2)) {
Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const items = await fetchByLoinc(v.loinc);
Â  Â  Â  Â  Â  Â  const rev = items.slice().reverse();
Â  Â  Â  Â  Â  Â  labels = rev.map(x=>new Date(x.when).toLocaleDateString());
Â  Â  Â  Â  Â  Â  values = rev.map(x=>{
Â  Â  Â  Â  Â  Â  Â  const m = /(-?\d+(\.\d+)?)/.exec(x.value||""); return m? Number(m[1]) : null;
Â  Â  Â  Â  Â  Â  }).filter(x=>x!==null);
Â  Â  Â  Â  Â  Â  latest = items[0]?.value || latest;
Â  Â  Â  Â  Â  } catch {}
Â  Â  Â  Â  }

Â  Â  Â  Â  const box = document.createElement('div'); box.className='vital';
Â  Â  Â  Â  box.innerHTML = `
Â  Â  Â  Â  Â  <div class="v-label">
Â  Â  Â  Â  Â  Â  <div class="v-name">${v.name}</div>
Â  Â  Â  Â  Â  Â  <div class="v-now">${latest ? latest : "<span class='muted'>â€”</span>"}</div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="v-meta">${v.unitHint}</div>
Â  Â  Â  Â  Â  <canvas></canvas>
Â  Â  Â  Â  `;
Â  Â  Â  	 gridBox.appendChild(box);

Â  Â  Â  Â  const ctx = box.querySelector('canvas');
Â  Â  Â  Â  if (values && values.length >= 2) {
Â  Â  Â  Â  Â  // We have a trend, draw it
Â  Â  Â  Â  Â  sparkline(ctx, labels, values);
Â  Â  Â  Â  } else if (values && values.length === 1) {
Â  Â  Â  Â  Â  // Only one point, draw a flat line at that value
Â  Â  Â  Â  Â  sparkline(ctx, [labels[0] || "", ""], [values[0], values[0]]);
Â  Â  Â  Â  }
Â  Â  Â  Â  // If no values, we do nothing, leaving the canvas clean.
Â  Â  Â  }

Â  Â  Â  /* ----- Coverage ----- */
Â  Â  Â  try{
Â  Â  Â  Â  const r = await client.request(`Coverage?patient=${patientId}&_count=5`);
Â  Â  Â  Â  const rows = (r.entry||[]).map(e=>e.resource).map(c=>({
Â  Â  Â  Â  Â  id:c.id, status:c.status||"", payor:(c.payor||[]).map(p=>p.display||p.reference).join(", ")
Â  Â  Â  Â  }));
Â  Â  Â  Â  const c = card("Coverage","ğŸ›¡ï¸","span-6");
Â  Â  Â  Â  c.appendChild(tbl(
Â  Â  Â  Â  Â  [
Â  Â  Â  Â  Â  Â  {key:"id",label:"ID",render:r=>`<span class="mono">${r.id}</span>`},
Â  Â  Â  Â  Â  Â  {key:"status",label:"Status"},
Â  Â  Â  Â  Â  Â  {key:"payor",label:"Payor"}
Â  Â  Â  Â  Â  ],
Â  Â  Â  Â  Â  rows
Â  	 Â  Â  ));
Â  Â  Â  }catch{}
Â  Â  })();
Â  </script>
</body>
</html>
